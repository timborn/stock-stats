#!/usr/bin/env bash
# self test stock-stats

source $HOME/bin/assert.sh

CACHE=$HOME/.stock-stats-cache

### will we populate the cache when it's not there?
# clear the cache
rm -rf $CACHE
stock-stats T > /dev/null
echo -n "populate cache correctly: "
[ -s $CACHE/T ] && echo PASS || echo FAIL 

### do we use the cache when available?
eval set `stat -s $CACHE/T`
BEFORE=$st_mtimespec
stock-stats T > /dev/null
eval set `stat -s $CACHE/T`
AFTER=$st_mtimespec
assert_eq $BEFORE $AFTER "FAIL: should uses cache when available"

### TODO: test error case - how to test when stock-stats-nocache not on path?

### expect usage when no arg presented
echo -n "usage msg when no args: "
stock-stats > /dev/null
[ $? -eq 2 ] && echo PASS || echo FAIL

### refill cache when data is old`
# warning: this depends on $CACHE/T exists and is current

eval set `stat -s $CACHE/T`
BEFORE=$st_mtimespec
touch -t 12042046 $CACHE/T
stock-stats > /dev/null
eval set `stat -s $CACHE/T`
AFTER=$st_mtimespec
assert_not_eq $BEFORE $AFTER "FAIL: should refill cache when too old"

# what a hack!
# eval set `stat -s $CACHE/T`
# $st_mtimespec

### expect specific output - probably won't change for a year
echo -n "5-yr-div-history.sh BAC: "
VAL=`./5-yr-div-history.sh BAC`
EXPECTED="2018 0.54
2019 0.66
2020 0.72
2021 0.78
2022 0.86"

# echo
# echo "DEBUG:      VAL="\'$VAL\'
# echo "DEBUG: EXPECTED="\'$EXPECTED\'
if [ "$VAL" = "$EXPECTED" ] ; then
	echo PASS
else
	echo FAIL
fi

# why doesn't this work?
# assert_eq "$VAL" "$EXPECTED" 


### expect specific output - probably won't change for a year
echo -n "25-yr-div-history.sh BAC: "
VAL=`./25-yr-div-history.sh BAC`
EXPECTED="

2014 0.12
2015 0.2
2016 0.25
2017 0.39
2018 0.54
2019 0.66
2020 0.72
2021 0.78
2022 0.86"

if [ "$VAL" = "$EXPECTED" ] ; then
	echo PASS
else
	echo FAIL
fi



### expect specific output - probably won't change for a year
echo -n "dividend-history3.sh BAC: "
VAL=`./dividend-history3.sh BAC`
EXPECTED="1986-06-02 0.047500
1986-08-29 0.047500
1986-12-01 0.052500
1987-03-02 0.052500
1987-06-01 0.052500
1987-08-31 0.052500
1987-11-30 0.057500
1988-02-29 0.057500
1988-05-27 0.057500
1988-08-29 0.057500
1988-11-28 0.062500
1989-02-27 0.062500
1989-05-26 0.062500
1989-08-28 0.075000
1989-11-27 0.075000
1990-02-26 0.087500
1990-05-25 0.087500
1990-08-31 0.087500
1990-12-03 0.092500
1991-03-04 0.092500
1991-06-03 0.092500
1991-08-30 0.092500
1991-12-02 0.092500
1992-03-02 0.092500
1992-06-01 0.092500
1992-08-31 0.092500
1992-11-30 0.100000
1993-03-01 0.100000
1993-05-28 0.100000
1993-08-30 0.105000
1993-11-29 0.105000
1994-02-28 0.115000
1994-05-27 0.115000
1994-08-29 0.115000
1994-11-28 0.125000
1995-02-27 0.125000
1995-05-26 0.125000
1995-08-30 0.125000
1995-11-29 0.145000
1996-02-28 0.145000
1996-06-05 0.145000
1996-09-04 0.145000
1996-12-04 0.165000
1997-03-05 0.165000
1997-06-04 0.165000
1997-09-03 0.165000
1997-12-03 0.190000
1998-03-04 0.190000
1998-06-03 0.190000
1998-09-02 0.190000
1998-12-02 0.225000
1999-03-03 0.225000
1999-06-02 0.225000
1999-09-01 0.225000
1999-12-01 0.250000
2000-03-01 0.250000
2000-05-31 0.250000
2000-08-30 0.250000
2000-11-29 0.280000
2001-02-28 0.280000
2001-05-30 0.280000
2001-09-05 0.280000
2001-12-05 0.300000
2002-02-27 0.300000
2002-06-05 0.300000
2002-09-04 0.300000
2002-12-04 0.320000
2003-03-05 0.320000
2003-06-04 0.320000
2003-09-03 0.400000
2003-12-03 0.400000
2004-03-03 0.400000
2004-06-02 0.400000
2004-09-01 0.450000
2004-12-01 0.450000
2005-03-02 0.450000
2005-06-01 0.450000
2005-08-31 0.500000
2005-11-30 0.500000
2006-03-01 0.500000
2006-05-31 0.500000
2006-08-30 0.560000
2006-11-29 0.560000
2007-02-28 0.560000
2007-05-30 0.560000
2007-09-05 0.640000
2007-12-05 0.640000
2008-03-05 0.640000
2008-06-04 0.640000
2008-09-03 0.640000
2008-12-03 0.320000
2009-03-04 0.010000
2009-06-03 0.010000
2009-09-02 0.010000
2009-12-02 0.010000
2010-03-03 0.010000
2010-06-02 0.010000
2010-09-01 0.010000
2010-12-01 0.010000
2011-03-02 0.010000
2011-06-01 0.010000
2011-08-31 0.010000
2011-11-30 0.010000
2012-02-29 0.010000
2012-05-30 0.010000
2012-09-05 0.010000
2012-12-05 0.010000
2013-02-27 0.010000
2013-06-05 0.010000
2013-09-04 0.010000
2013-12-04 0.010000
2014-03-05 0.010000
2014-06-20 0.010000
2014-09-03 0.050000
2014-12-03 0.050000
2015-03-04 0.050000
2015-06-03 0.050000
2015-09-02 0.050000
2015-12-02 0.050000
2016-03-02 0.050000
2016-06-01 0.050000
2016-08-31 0.075000
2016-11-30 0.075000
2017-03-01 0.075000
2017-05-31 0.075000
2017-08-30 0.120000
2017-11-30 0.120000
2018-03-01 0.120000
2018-05-31 0.120000
2018-09-06 0.150000
2018-12-06 0.150000
2019-02-28 0.150000
2019-06-06 0.150000
2019-09-05 0.180000
2019-12-05 0.180000
2020-03-05 0.180000
2020-06-04 0.180000
2020-09-03 0.180000
2020-12-03 0.180000"

if [ "$VAL" = "$EXPECTED" ] ; then
	echo PASS
else
	echo FAIL
fi



